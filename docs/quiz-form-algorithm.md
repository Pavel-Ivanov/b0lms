# Алгоритм работы компонента QuizForm

## Архитектура компонента

Компонент `QuizForm` использует паттерн проектирования "Состояние" (State Pattern) для управления различными состояниями теста. Это позволяет изолировать логику, связанную с каждым состоянием, в отдельных классах, что делает код более модульным и легким для поддержки.

### Основные классы

1. **QuizForm** - основной компонент Livewire, который управляет состояниями и содержит общие данные.
2. **QuizFormState** - абстрактный базовый класс для всех состояний.
3. **QuizTestState** - состояние прохождения теста.
4. **QuizIntermediateResultState** - состояние промежуточного результата (когда тест не пройден, но есть еще попытки).
5. **QuizFinalResultState** - состояние окончательного результата (когда тест пройден или исчерпаны все попытки).

## Инициализация компонента

При монтировании компонента (`mount()`) происходит следующее:

1. Инициализация основных свойств:
   - `$quiz` - модель теста
   - `$enrollment` - модель зачисления на курс
   - `$activeStep` - текущий шаг в прохождении курса
   - `$questions` - вопросы теста
   - `$correctAnswers` - правильные ответы на вопросы

2. Получение информации о предыдущих попытках:
   - `$attemptCount` - количество уже сделанных попыток
   - `$maxAttemptsReached` - флаг, указывающий, достигнуто ли максимальное количество попыток
   - `$isPassed` - флаг, указывающий, был ли тест успешно пройден ранее
   - `$latestTest` - последняя попытка прохождения теста

3. Инициализация состояний через метод `initializeStates()`:
   ```php
   $this->states = [
       'test' => new QuizTestState($this),
       'intermediate-result' => new QuizIntermediateResultState($this),
       'final-result' => new QuizFinalResultState($this),
   ];
   ```

4. Определение начального состояния через метод `determineInitialState()`:
   - Если есть предыдущая попытка и не запрошена новая:
     - Если тест пройден или достигнуто максимальное количество попыток, устанавливается состояние `final-result`
     - Иначе устанавливается состояние `intermediate-result`
   - Если предыдущих попыток нет или запрошена новая попытка, устанавливается состояние `test`

## Управление состояниями

Компонент использует следующие методы для управления состояниями:

1. **setState(string $state)** - устанавливает текущее состояние, проверяя его валидность.
2. **getCurrentState()** - возвращает текущий объект состояния, обеспечивая инициализацию состояний и проверку валидности текущего состояния.

## Жизненный цикл прохождения теста

### 1. Состояние теста (QuizTestState)

Когда компонент находится в состоянии `test`:

1. Пользователь видит форму с вопросами теста.
2. При отправке формы вызывается метод `submit()` текущего состояния.
3. В методе `submit()` происходит:
   - Проверка, не достигнуто ли максимальное количество попыток или не пройден ли тест ранее
   - Создание новой записи теста в базе данных
   - Обработка ответов пользователя и подсчет результата
   - Расчет процента правильных ответов
   - Обновление счетчика попыток
   - Если тест пройден (процент правильных ответов >= проходного):
     - Шаг отмечается как завершенный
     - Следующий шаг становится доступным
     - Происходит переход в состояние `final-result`
   - Если тест не пройден и есть еще попытки:
     - Происходит переход в состояние `intermediate-result`
   - Формирование сообщения о результате
   - Отправка событий для обновления интерфейса

### 2. Состояние промежуточного результата (QuizIntermediateResultState)

Когда компонент находится в состоянии `intermediate-result`:

1. Пользователь видит результаты своей попытки и кнопку "Повторить попытку".
2. При нажатии на кнопку "Повторить попытку" вызывается метод `resetResults()` компонента, который делегирует обработку методу `handleTransition('retry')` текущего состояния.
3. В методе `handleTransition('retry')` происходит:
   - Установка флага `$showNewAttemptForm = true`
   - Сброс данных формы
   - Обновление времени начала теста
   - Переход в состояние `test`
   - Отправка событий для обновления интерфейса

### 3. Состояние окончательного результата (QuizFinalResultState)

Когда компонент находится в состоянии `final-result`:

1. Пользователь видит окончательные результаты теста.
2. Если тест пройден, отображается сообщение об успешном прохождении.
3. Если достигнуто максимальное количество попыток, отображается сообщение о необходимости решения администратора.
4. Пользователь может нажать на кнопку "Подробные результаты", что вызовет метод `viewDetails()` компонента, который делегирует обработку методу `viewDetails()` состояния `final-result`.

## Отображение интерфейса

Метод `render()` компонента делегирует отображение текущему состоянию:

```php
public function render()
{
    return view($this->getCurrentState()->view(), [
        'message' => $this->getCurrentState()->getMessage(),
        'messageStyle' => $this->getCurrentState()->getMessageStyle(),
    ]);
}
```

Каждое состояние определяет:
- Какой шаблон использовать (`view()`)
- Какое сообщение отображать (`getMessage()`)
- Какой стиль применить к сообщению (`getMessageStyle()`)

## Критерии успешного прохождения теста

Тест считается успешно пройденным, если процент правильных ответов больше или равен значению `passing_percentage` модели Quiz (по умолчанию 80%).

Расчет процента правильных ответов:
```php
$percentage = $totalQuestions > 0 ? ($result / $totalQuestions) * 100 : 0;
$isPassed = $percentage >= $this->component->quiz->passing_percentage;
```

## Ограничение попыток

Количество попыток ограничено значением `max_attempts` модели Quiz (по умолчанию 3).

Проверка достижения максимального количества попыток:
```php
$this->maxAttemptsReached = $this->attemptCount >= $this->quiz->max_attempts;
```

## Схема алгоритма

```
┌─────────────────┐
│     Монтирование     │
│    компонента    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Инициализация  │
│    состояний    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Определение    │
│начального состояния│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Отображение   │
│     формы       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Отправка      │
│    формы        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Обработка      │
│   ответов       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Расчет         │
│  результата     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Проверка       │
│  критериев      │
└────────┬────────┘
         │
         ▼
      ┌──┴──┐
 ┌────▼┐   ┌▼────┐
 │Пройден│   │Не пройден│
 └────┬─┘   └┬────┘
      │      │
      │      │
      │      ▼
      │  ┌───────────┐
      │  │Есть еще   │
      │  │попытки?   │
      │  └───┬───────┘
      │      │
      │   ┌──┴──┐
      │┌──▼┐  ┌▼──┐
      ││Да │  │Нет│
      │└┬──┘  └┬──┘
      │ │      │
      ▼ ▼      ▼
┌────────┐ ┌────────┐ ┌────────┐
│final-  │ │inter-  │ │final-  │
│result  │ │mediate-│ │result  │
│(успех) │ │result  │ │(неудача)│
└────────┘ └────────┘ └────────┘
```

## Заключение

Компонент QuizForm использует паттерн "Состояние" для управления различными состояниями теста, что делает код более модульным и легким для поддержки. Каждое состояние инкапсулирует свою логику и представление, а компонент делегирует обработку текущему состоянию. Это позволяет легко добавлять новые состояния или изменять существующие без необходимости модификации основного компонента.
