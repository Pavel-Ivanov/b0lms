# Алгоритм и структура компонента TestManager

## Общая структура компонента

Компонент TestManager - это Livewire-компонент, который предназначен для управления процессом прохождения тестов в системе обучения. Он заменяет старый компонент QuizForm и предоставляет более гибкий и надежный способ управления тестированием.

Компонент имеет следующие основные свойства:
- `$quiz` - объект теста, который проходит пользователь
- `$userTestAttempt` - текущая попытка прохождения теста
- `$stepAttempt` - попытка прохождения шага обучения (если тест является частью шага обучения)
- `$questions` - коллекция вопросов теста
- `$userAnswers` - массив ответов пользователя
- `$currentState` - текущее состояние компонента
- `$currentQuestionIndex` - индекс текущего вопроса

## Инициализация компонента

Инициализация компонента происходит в методе `mount()`, который вызывается при первой загрузке компонента. Процесс инициализации включает следующие шаги:

1. Загрузка теста и его вопросов
2. Поиск или создание попытки прохождения шага обучения (если тест является частью шага)
3. Поиск или создание попытки прохождения теста
4. Определение начального состояния компонента

### Поиск или создание попытки прохождения шага обучения

Метод `findOrCreateStepAttempt()` выполняет следующие действия:
1. Проверяет, передан ли параметр `$enrollmentStep`
2. Если да, ищет последнюю попытку прохождения этого шага для текущего пользователя
3. Если попытка не найдена, создает новую со статусом "pending", номером попытки 1 и флагом "passed" = false

### Поиск или создание попытки прохождения теста

Метод `findOrCreateTestAttempt()` выполняет следующие действия:
1. Ищет последнюю попытку прохождения теста для текущего пользователя и теста
2. Если есть попытка прохождения шага, фильтрует по ней
3. Если попытка не найдена, создает новую со статусом "pending", номером попытки 0 и флагом "passed" = false
4. Если статус попытки "in_progress", загружает сохраненные ответы

## Управление состояниями

Компонент имеет четыре основных состояния:
1. `initial_screen` - начальный экран с информацией о тесте и кнопкой "Начать тест"
2. `test_form` - форма прохождения теста с вопросами и навигацией
3. `result` - экран с результатами попытки
4. `final` - экран с итоговым результатом (когда тест пройден или исчерпаны все попытки)

Метод `determineState()` определяет текущее состояние компонента на основе следующих правил:
1. Если попытка прохождения шага имеет флаг "passed" = true, устанавливает состояние "final"
2. Если попытка прохождения теста имеет флаг "passed" = true, устанавливает состояние "final"
3. Если исчерпаны все попытки и тест не пройден, устанавливает состояние "final"
4. В зависимости от статуса попытки:
   - "pending" или "completed" - устанавливает состояние "initial_screen"
   - "in_progress" - устанавливает состояние "test_form"

## Отслеживание попыток прохождения теста

Компонент отслеживает попытки прохождения теста с помощью моделей `Test` и `EnrollmentStepAttempt`. Модель `Test` хранит информацию о конкретной попытке прохождения теста, а модель `EnrollmentStepAttempt` хранит информацию о попытке прохождения шага обучения, который может включать тест.

Когда пользователь начинает тест, метод `startTest()` выполняет следующие действия:
1. Если есть попытка прохождения шага, обновляет ее статус на "in_progress"
2. Увеличивает счетчик попыток в попытке прохождения теста
3. Сбрасывает результат и устанавливает статус "in_progress"
4. Устанавливает время начала теста
5. Удаляет предыдущие ответы
6. Устанавливает состояние "test_form" и индекс текущего вопроса в 0

## Навигация по вопросам

Компонент предоставляет несколько способов навигации по вопросам:
1. Кнопки "Назад" и "Далее" для последовательной навигации
2. Сетка с номерами вопросов для прямого перехода к любому вопросу
3. Кнопка "Завершить тест" на последнем вопросе

Методы `nextQuestion()` и `previousQuestion()` изменяют индекс текущего вопроса, а метод `getCurrentQuestion()` возвращает текущий вопрос на основе этого индекса.

## Сохранение ответов

Когда пользователь выбирает ответ на вопрос, метод `saveAnswer()` выполняет следующие действия:
1. Сохраняет ответ в массиве `$userAnswers`
2. Создает или обновляет запись в таблице `test_answers` с информацией о выбранном варианте ответа
3. Определяет, правильный ли ответ, и сохраняет эту информацию

## Расчет результатов

Когда пользователь завершает тест, метод `finishTest()` вызывает метод `calculateScoreAndFinishAttempt()`, который выполняет следующие действия:
1. Подсчитывает количество правильных ответов
2. Вычисляет процент правильных ответов
3. Определяет, пройден ли тест (если процент правильных ответов >= проходного балла)
4. Обновляет попытку прохождения теста: результат, статус "completed", флаг "passed", время завершения
5. Если есть попытка прохождения шага:
   - Вычисляет время, затраченное на тест
   - Обновляет попытку прохождения шага: статус "completed", флаг "passed", результат, время
   - Если тест пройден, отмечает шаг обучения как завершенный

## Интеграция с EnrollmentStepAttempt

Компонент TestManager интегрируется с моделью EnrollmentStepAttempt, которая представляет попытку прохождения шага обучения. Эта интеграция позволяет:
1. Отслеживать прогресс пользователя в рамках всего курса обучения
2. Связывать попытки прохождения тестов с конкретными шагами обучения
3. Автоматически отмечать шаги обучения как завершенные при успешном прохождении тестов
4. Сохранять дополнительную информацию, такую как время, затраченное на прохождение шага

## Повторное прохождение теста

Если пользователь не прошел тест и у него остались попытки, он может пройти тест повторно. Метод `retakeTest()` выполняет следующие действия:
1. Проверяет, есть ли у пользователя доступные попытки и не пройден ли уже тест
2. Если есть попытка прохождения шага, увеличивает счетчик попыток
3. Вызывает метод `startTest()` для начала новой попытки

## Отображение компонента

Компонент использует различные шаблоны Blade для отображения разных состояний:
1. `test-manager.blade.php` - основной шаблон, который включает соответствующий шаблон состояния
2. `initial-screen.blade.php` - начальный экран с информацией о тесте
3. `test-form.blade.php` - форма прохождения теста с вопросами и навигацией
4. `result.blade.php` - экран с результатами попытки
5. `final.blade.php` - экран с итоговым результатом

Метод `render()` передает в шаблон все необходимые данные: тест, попытку прохождения теста, попытку прохождения шага, текущий вопрос, общее количество вопросов, номер текущего вопроса и текущую попытку.
