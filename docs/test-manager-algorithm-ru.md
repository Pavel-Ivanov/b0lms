# Алгоритм работы компонента "TestManager"

## Общая структура компонента

Компонент TestManager - это Livewire-компонент, который предназначен для управления процессом прохождения тестов в системе обучения. Он заменяет старый компонент QuizForm и предоставляет более гибкий и надежный способ управления тестированием.

## Основные свойства компонента

- `$quiz` - объект теста, который проходит пользователь
- `$enrollment` - объект записи на курс (опционально)
- `$enrollmentStep` - шаг обучения, к которому привязан тест (опционально)
- `$userTestAttempt` - текущая попытка прохождения теста
- `$questions` - коллекция вопросов теста
- `$userAnswers` - массив ответов пользователя
- `$currentState` - текущее состояние компонента
- `$currentQuestionIndex` - индекс текущего вопроса
- `$correctAnswers` - массив правильных ответов

## Инициализация компонента (метод mount)

1. Компонент получает объект Quiz, опционально Enrollment и EnrollmentStep в качестве параметров.
2. Загружает все вопросы и варианты ответов для данного теста.
3. Формирует массив правильных ответов для каждого вопроса.
4. Вызывает метод findOrCreateTestAttempt() для поиска или создания записи теста.
5. Вызывает метод determineState() для определения начального состояния компонента.

## Поиск или создание попытки прохождения теста (метод findOrCreateTestAttempt)

1. Ищет последнюю попытку прохождения теста для текущего пользователя и данного теста.
2. Если есть шаг обучения (enrollmentStep), фильтрует по нему.
3. Если попытка не найдена, создает новую со следующими параметрами:
   - user_id = ID текущего пользователя
   - quiz_id = ID текущего теста
   - enrollment_step_id = ID шага обучения (если есть)
   - result = 0
   - status = 'pending'
   - current_attempt = 0
   - passed = false
4. Если найдена попытка со статусом 'in_progress' и сохраненными ответами, загружает эти ответы в $userAnswers.

## Определение состояния компонента (метод determineState)

1. Проверяет userTestAttempt->passed:
   - Если true, устанавливает currentState = 'final' (тест успешно пройден).
2. Проверяет количество попыток:
   - Если current_attempt >= max_attempts и тест не пройден, устанавливает currentState = 'final' и status = 'failed_attempts'.
3. Проверяет userTestAttempt->status:
   - Если 'pending' или 'completed', устанавливает currentState = 'initial_screen' (экран "Начать тест").
   - Если 'in_progress', устанавливает currentState = 'test_form' (форма прохождения теста).

## Начало теста (метод startTest)

1. Увеличивает счетчик попыток (current_attempt).
2. Сбрасывает результат (result = 0).
3. Устанавливает статус 'in_progress'.
4. Устанавливает время начала теста (started_at = now()).
5. Очищает массив ответов.
6. Устанавливает currentState = 'test_form'.
7. Устанавливает currentQuestionIndex = 0 (первый вопрос).

## Сохранение ответа (метод saveAnswer)

1. Сохраняет выбранный ответ в массив $userAnswers.
2. Обновляет поле answers в записи теста в базе данных.
3. Определяет, правильный ли ответ, сравнивая с массивом $correctAnswers.
4. Создает или обновляет запись TestAnswer с информацией о выбранном варианте ответа.

## Навигация по вопросам (методы nextQuestion и previousQuestion)

1. nextQuestion увеличивает индекс текущего вопроса, если он не последний.
2. previousQuestion уменьшает индекс текущего вопроса, если он не первый.
3. getCurrentQuestion возвращает текущий вопрос на основе индекса.

## Завершение теста (метод finishTest)

1. Вызывает метод calculateScoreAndFinishAttempt для подсчета результатов.
2. Устанавливает currentState = 'result' для отображения результатов.

## Расчет результатов (метод calculateScoreAndFinishAttempt)

1. Подсчитывает количество правильных ответов, сравнивая ответы пользователя с правильными ответами.
2. Вычисляет процент правильных ответов.
3. Определяет, пройден ли тест (если процент правильных ответов >= проходного балла).
4. Обновляет запись теста:
   - result = количество правильных ответов
   - status = 'completed'
   - passed = true/false в зависимости от результата
   - completed_at = текущее время
   - time_spent = разница между started_at и completed_at
5. Если тест пройден и есть шаг обучения:
   - Отмечает шаг обучения как завершенный (is_completed = true).
   - Находит следующий шаг и делает его доступным (is_enabled = true).
   - Отправляет события для обновления интерфейса.
6. Отправляет уведомление пользователю о результате теста.

## Повторное прохождение теста (метод retakeTest)

1. Проверяет, есть ли у пользователя доступные попытки и не пройден ли уже тест.
2. Если условия выполняются, вызывает метод startTest для начала новой попытки.
3. Если нет, отправляет уведомление о том, что попытки исчерпаны или тест уже пройден.

## Отображение компонента (метод render)

1. Возвращает представление 'livewire.test-manager' с передачей следующих данных:
   - quiz - объект теста
   - userTestAttempt - текущая попытка прохождения теста
   - currentQuestion - текущий вопрос
   - totalQuestions - общее количество вопросов
   - currentQuestionNumber - номер текущего вопроса (начиная с 1)

## Состояния интерфейса

Компонент имеет четыре основных состояния, которые определяют, какой шаблон будет отображаться:

1. **initial_screen** - начальный экран с информацией о тесте и кнопкой "Начать тест".
2. **test_form** - форма прохождения теста с вопросами и вариантами ответов.
3. **result** - экран с результатами последней попытки.
4. **final** - финальный экран, который показывается, когда тест пройден или исчерпаны все попытки.

Каждое состояние имеет свой собственный шаблон Blade, который отображается в зависимости от значения $currentState.
